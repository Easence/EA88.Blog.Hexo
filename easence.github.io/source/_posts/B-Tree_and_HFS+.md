---
title: 基于B树的HFS+文件系统
categories: 
 - Apple Development
 - 深入解析Mac OS X && iOS操作系统笔记 
tags:
- 文件系统
---
# B树基础
## 定义
网络上或者算法书上可以看到很多对B树的定义，比如这篇文章：[《B树》][1]。在理解这个定义的时候，我们需要理解这些概念：

- key：树节点的键值（关键字），同一个节点的键值应该是顺序排列的。
- 度：一个节点子树的数目。
- 阶：所有节点的子树数目最大值。用m表示。

然后再看定义：

- 树中每个结点最多含有m个孩子（m>=2）；
- 除根结点和叶子结点外，其它每个结点至少有[ceil(m / 2)]个孩子（其中ceil(x)是一个取上限的函数）；
- 根结点至少有2个孩子（除非B树只包含一个结点：根结点）；
- 所有叶子结点都出现在同一层，叶子结点不包含任何关键字信息(可以看做是外部结点或查询失败的结点，指向这些结点的指针都为null)；（注：叶子节点只是没有孩子和指向孩子的指针，这些节点也存在，也有元素。类似红黑树中，每一个NULL指针即当做叶子结点，只是没画出来而已）。
- 每个非终端结点中包含有n个关键字信息： (n，P0，K1，P1，K2，P2，......，Kn，Pn)。其中： 
	1. Ki (i=1...n)为关键字，且关键字按顺序升序排序K(i-1)< Ki。 
	2. Pi为指向子树根的结点，且指针P(i-1)指向子树种所有结点的关键字均小于Ki，但都大于K(i-1)。 
	3. 关键字的个数n必须满足： [ceil(m / 2)-1]<= n <= m-1。比如有j个孩子的非叶结点恰好有j-1个关键码。

## 插入

- 如果叶子结点空间足够，即该结点的关键字数小于m-1，则直接插入在叶子结点的左边或右边；
- 如果空间满了以致没有足够的空间去添加新的元素，即该结点的关键字数已经有了m个，则需要将该 结点 进行“分裂”，将一半数量的关键字元素分裂到新的其相邻右结点中，中间关键字元素上移到父结点中，而且当结点中关键元素向右移动了，相关的指针也需要向右移。
- 此外，如果在上述中间关键字上移到父结点的过程中，导致根结点空间满了，那么根结点也要进行分裂操作，这样原来的根结点中的中间关键字元素向上移动到新的根结点中，因此导致树的高度增加一层。

> 具体实例见[《B树》][1]中的“插入”小节。

## 删除
删除操作相对于插入操作要考虑的情况多点。

- 首先查找B树中需删除的元素,如果该元素在B树中存在，则将该元素在其结点中进行删除，如果删除该元素后，首先判断该元素是否有左右孩子结点
	1. 如果有，则上移孩子结点中的某相近元素(“左孩子最右边的节点”或“右孩子最左边的节点”)到父节点中，然后是移动之后的情况；
	2. 如果没有，直接删除后，移动之后的情况。
- 删除元素，移动相应元素之后，如果某结点中元素数目（即关键字数）小于 ceil(m/2)-1 ，则需要看其某相邻兄弟结点是否丰满（结点中元素个数大于ceil(m/2)-1）
	1. 如果丰满，则向父节点借一个元素来满足条件；
	2. 如果其相邻兄弟都刚脱贫，即借了之后其结点数目小于ceil(m/2)-1，则该结点与其相邻的某一兄弟结点进行“合并”成一个结点，以此来满足条件。

> 具体实例见[《B树》][1]中的“删除”小节。

## B树的优点
B树是一棵多叉树，在查找数据的过程中最优的情况下时间复杂度是logm(n),最坏情况下是logm/2(n)，（m表示B数的阶），因此B树大部分情况下能提供指数时间的复杂度。对于文件系统的搜索、删除、插入、更新、随机访问都能提供较快，较稳定的时间复杂度。

## B树与Hash的对比
在做对比前，我们已经理解Hash以及B树的查找原理分别是怎样的。

- Hash相当于把key通过hash函数计算，得到key的hash值,再用这个hash值做指针，查找hash表中是否存在key，如果存在就返回 key所对应的value，选定一个好的hash函数很重要，好的hash函数可以使计算出的hash值分布均匀，降低冲突，只有冲突减小了，才会降低 hash表的查找时间。
- B-tree完全基于key的比较，和二叉树相同的道理，相当于建个排序后的数据集，使用二分法查找算法，实际上也非常快，而且受数据量增长影响非常小。

为什么很多数据库或文件系统采用了B树做数据结构，而不采用hash？

- Hash索引仅满足“=”、“IN”和“<=>”查询，不能使用范围查询。
- Hash索引无法被用来进行数据的排序操作。
- Hash索引遇到大量Hash值相等的情况后性能并不一定就会比B-Tree索引高。

# HFS+文件系统
HFS+文件系统采用了6个特殊的文件来维护自己的数据，其中有四个是B树，分别是：

- **编录B树**：包含文件系统的所有目录以及文件，也就是说用户对文件的所有操作都会影响到这个文件。
- **属性B树**：用于支持文件扩展属性。
- **extent溢出B树**：用于超过8个碎片（或extent，一个extent表示一组连续的分配块）的文件。
- **热文件B树**：用户频繁访问的小文件。

两个文件是：

- **分配文件**：一个位图，包含文件系统中所有数据块的使用情况，其中每一位代表一个数据块的使用情况。
- **启动文件**：一个可执行文件，用于引导操作系统。MacOS X已经弃用了，其他操作系统可以使用。

如果HFS+挂载的时候启用了日志功能，那么还会启用一个日志文件。


## 参考文献：
1. [B树][1]

[1]: http://taop.marchtea.com/03.02.html

